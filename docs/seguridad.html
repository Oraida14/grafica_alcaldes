<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Seguridad - Tanque Alcaldes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }

    /* Clase para los valores de las m칠tricas */
  .metric-value {
    color: white; /* Color blanco */
    font-weight: bold; /* Opcional: para hacer el texto m치s destacado */
    font-size: 1.2em; /* Opcional: para aumentar el tama침o del texto */
  }

    .card {
      width: 100%;
      background: linear-gradient(145deg, #2c3e50, #34495e);
      border-radius: 15px;
      margin-bottom: 20px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s, box-shadow 0.3s;
      box-sizing: border-box;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    }
    .chart-container {
      width: 100%;
      height: 400px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
    }
    .alert-danger {
      color: #a94442;
      background-color: #f2dede;
      border-color: #ebccd1;
    }
    h1, h4, h5 {
      color: #ecf0f1;
    }
    .metrics-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .metric-card {
      flex: 1;
      min-width: 200px;
      margin: 10px;
    }
    .navbar {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- 游댳 Navbar corregido -->
<!-- 游댳 Navbar corregido -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Tanque Alcaldes</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="index.html">An치lisis General</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reporte.html">Reporte</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="seguridad.html">Seguridad</a>
        </li>
         <li class="nav-item">
          <a class="nav-link" href="https://oraida14.github.io/grafica_alcaldes/trabajando.html">An치lisis</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://oraida14.github.io/grafica_alcaldes/trabajando.html">Detalle Alertas</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  // 游댳 Resaltar pesta침a activa seg칰n la URL
  const currentPage = window.location.pathname.split("/").pop(); // obtiene index.html, reporte.html, etc.
  const navLinks = document.querySelectorAll('.navbar-nav .nav-link');

  navLinks.forEach(link => {
    if (link.getAttribute('href') === currentPage) {
      link.classList.add('active');
    } else {
      link.classList.remove('active');
    }
  });
</script>



  <h1 class="text-center mb-4">An치lisis de Seguridad - Tanque Alcaldes</h1>
  <div id="alertas" class="alert alert-danger" style="display: none;"></div>
  <div class="metrics-container">
  <div class="metric-card">
    <div class="card">
      <h5>Nivel Inicial (Noche)</h5>
      <p id="nivelInicialNoche" class="metric-value">--</p>
    </div>
  </div>
  <div class="metric-card">
    <div class="card">
      <h5>Nivel Final (Noche)</h5>
      <p id="nivelFinalNoche" class="metric-value">--</p>
    </div>
  </div>
  <div class="metric-card">
    <div class="card">
      <h5>Volumen Rebombeado (Noche)</h5>
      <p id="volumenRebombeadoNoche" class="metric-value">--</p>
    </div>
  </div>
  <div class="metric-card">
    <div class="card">
      <h5>Gasto Promedio (Noche)</h5>
      <p id="gastoPromedioNoche" class="metric-value">--</p>
    </div>
  </div>
</div>

  <div class="card">
    <h4 class="text-center">Comportamiento Nocturno del Tanque</h4>
    <div class="chart-container">
      <canvas id="nivelChartNoche"></canvas>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function fetchData() {
  const reporteUrl = 'https://raw.githubusercontent.com/Oraida14/grafica_alcaldes/master/reporte_tanque.json';
  const csvUrl = 'https://raw.githubusercontent.com/Oraida14/grafica_alcaldes/master/static/tanque_alcaldes.csv';

  // Cargar datos CSV
  const response = await fetch(csvUrl);
  const csvText = await response.text();
  const results = Papa.parse(csvText, {
    header: true,
    dynamicTyping: true,
  });
  let data = results.data;

  // Filtrar niveles cero que duren menos de 30 minutos
  let filteredData = [];
  let zeroStartTime = null;

  for (let i = 0; i < data.length; i++) {
    if (data[i].Nivel_1 === 0) {
      if (zeroStartTime === null) {
        zeroStartTime = new Date(data[i].fecha_hora);
      }
      // Si es el 칰ltimo dato, a침adirlo si no supera los 30 minutos
      if (i === data.length - 1 && zeroStartTime !== null) {
        let zeroEndTime = new Date(data[i].fecha_hora);
        let zeroDuration = (zeroEndTime - zeroStartTime) / (1000 * 60); // Duraci칩n en minutos
        if (zeroDuration > 30) { // Si dura m치s de 30 minutos, incluirlo
          filteredData.push(data[i]);
        }
      }
    } else {
      if (zeroStartTime !== null) {
        let zeroEndTime = new Date(data[i - 1].fecha_hora);
        let zeroDuration = (zeroEndTime - zeroStartTime) / (1000 * 60); // Duraci칩n en minutos
        if (zeroDuration > 30) { // Si dura m치s de 30 minutos, incluir los ceros
          for (let j = i - 1; j >= 0 && new Date(data[j].fecha_hora) >= zeroStartTime; j--) {
            filteredData.push(data[j]);
          }
        }
        zeroStartTime = null;
      }
      filteredData.push(data[i]);
    }
  }

  // Filtrar datos nocturnos
  const filteredDataNoche = filteredData.filter(d => {
    const hora = new Date(d.fecha_hora).getHours();
    return hora >= 16 || hora < 6;
  });

  // Cargar reporte JSON
  const reporteResponse = await fetch(reporteUrl);
  const reporte = await reporteResponse.json();

  // Mostrar m칠tricas nocturnas
  const noche = reporte.noche;
  document.getElementById('nivelInicialNoche').textContent = noche.tirante_inicio + ' m';
  document.getElementById('nivelFinalNoche').textContent = noche.tirante_fin + ' m';
  document.getElementById('volumenRebombeadoNoche').textContent = noche.volumen_rebombeado + ' m췁';
  document.getElementById('gastoPromedioNoche').textContent = noche.gasto_lps + ' L/s';

  // Mostrar alertas
  if (noche.alertas && noche.alertas.length > 0) {
    const alertasDiv = document.getElementById('alertas');
    alertasDiv.style.display = 'block';
    alertasDiv.innerHTML = noche.alertas.join('<br>');
  }

  // Crear gr치fico nocturno
  const ctx = document.getElementById('nivelChartNoche').getContext('2d');
  document.getElementById('nivelChartNoche').style.width = '100%';
  document.getElementById('nivelChartNoche').style.height = '100%';

  const niveles = filteredDataNoche.map(d => d.Nivel_1);
  const fechas = filteredDataNoche.map(d => d.fecha_hora);

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: fechas,
      datasets: [{
        label: 'Nivel (m)',
        data: niveles,
        borderColor: 'rgba(219, 52, 52, 1)',
        backgroundColor: 'rgba(219, 52, 52, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 0,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      plugins: {
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleColor: '#ecf0f1',
          bodyColor: '#ecf0f1',
          padding: 10,
          displayColors: false,
        },
        title: {
          display: true,
          text: 'Nivel del Tanque Alcaldes - Comportamiento Nocturno',
          color: '#ecf0f1',
          font: {
            size: 16
          }
        }
      },
      scales: {
        x: {
          display: true,
          title: {
            display: true,
            text: 'Fecha/Hora',
            color: '#ecf0f1'
          },
          ticks: {
            color: '#bdc3c7'
          }
        },
        y: {
          display: true,
          title: {
            display: true,
            text: 'Nivel (m)',
            color: '#ecf0f1'
          },
          ticks: {
            color: '#bdc3c7',
            beginAtZero: false
          }
        }
      }
    }
  });
}


    fetchData();
  </script>
</body>
</html>
