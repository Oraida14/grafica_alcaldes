<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalles de Alertas - Tanque Alcaldes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    .card {
      width: 100%;
      background: linear-gradient(145deg, #2c3e50, #34495e);
      border-radius: 15px;
      margin-bottom: 20px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s, box-shadow 0.3s;
      box-sizing: border-box;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
    }
    h1, h4, h5 { color: #ecf0f1; }
    table {
      color: #e0e0e0;
      width: 100%;
      margin-bottom: 20px;
      border-collapse: collapse;
    }
    table th, table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    table th { background-color: #2c3e50; }
    .navbar { margin-bottom: 20px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Tanque Alcaldes</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">Análisis General</a></li>
          <li class="nav-item"><a class="nav-link" href="reporte.html">Reporte</a></li>
          <li class="nav-item"><a class="nav-link" href="seguridad.html">Seguridad</a></li>
          <li class="nav-item"><a class="nav-link" href="analisis.html">Análisis</a></li>
          <li class="nav-item"><a class="nav-link" href="detalle_alertas.html">Detalle Alertas</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <script>
    // Resaltar pestaña activa
    const currentPage = window.location.pathname.split("/").pop();
    const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
    navLinks.forEach(link => {
      link.classList.toggle('active', link.getAttribute('href') === currentPage);
    });
  </script>

  <h1 class="text-center mb-4">Detalles de Alertas - Tanque Alcaldes</h1>

  <div class="card">
    <h4 class="text-center">Eventos Significativos</h4>
    <table id="eventosTable">
      <thead>
        <tr>
          <th>Fecha/Hora</th>
          <th>Nivel (m)</th>
          <th>Duración (min)</th>
          <th>Descripción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    async function fetchAlertas() {
      const csvUrl = 'https://raw.githubusercontent.com/Oraida14/grafica_alcaldes/master/static/tanque_alcaldes.csv';
      
      // Cargar datos CSV
      const response = await fetch(csvUrl);
      const csvText = await response.text();
      const results = Papa.parse(csvText, { header: true, dynamicTyping: true });
      let data = results.data;

      // Filtrar ceros falsos
      data = filtrarDatosValidos(data);

      // Calcular comportamiento histórico
      const historico = calcularParametroHistorico(data);

      // Detectar alertas
      const eventos = detectarAlertasInteligentes(data, historico);

      // Mostrar en tabla
      const tbody = document.getElementById('eventosTable').querySelector('tbody');
      tbody.innerHTML = "";
      eventos.forEach(ev => {
        const row = tbody.insertRow();
        row.insertCell(0).textContent = ev.fechaHora;
        row.insertCell(1).textContent = ev.nivel;
        row.insertCell(2).textContent = ev.duracion;
        row.insertCell(3).textContent = ev.descripcion;
        
        if (ev.tipo === 'alerta') row.style.backgroundColor = '#f8d7da'; // rojo
        if (ev.tipo === 'descenso') row.style.backgroundColor = '#fff3cd'; // amarillo
        if (ev.tipo === 'subida') row.style.backgroundColor = '#d1ecf1'; // azul
      });
    

    function filtrarDatosValidos(data) {
      let filtered = [];
      let zeroStart = null;

      for (let i=0;i<data.length;i++){
        const nivel = data[i].Nivel_1;
        const fecha = new Date(data[i].fecha_hora);
        if(nivel===0){
          if(!zeroStart) zeroStart = fecha;
          if(i===data.length-1){
            const dur = (fecha - zeroStart)/(1000*60);
            if(dur>60) filtered.push(data[i]);
          }
        } else {
          if(zeroStart){
            const dur = (fecha - zeroStart)/(1000*60);
            if(dur>60){
              for(let j=0;j<=i;j++) filtered.push(data[j]);
            }
            zeroStart = null;
          }
          filtered.push(data[i]);
        }
      }
      return filtered;
    }

    function calcularParametroHistorico(data){
      const niveles = data.map(d=>d.Nivel_1);
      const promedio = niveles.reduce((a,b)=>a+b,0)/niveles.length;
      const desviacion = Math.sqrt(niveles.reduce((sq,n)=>sq+Math.pow(n-promedio,2),0)/niveles.length);
      return {promedio, desviacion};
    }

    function detectarAlertasInteligentes(data, historico){
      const eventos = [];
      let prevNivel = data[0].Nivel_1;
      let prevFecha = new Date(data[0].fecha_hora);

      for(let i=1;i<data.length;i++){
        const nivel = data[i].Nivel_1;
        const fecha = new Date(data[i].fecha_hora);
        const cambio = nivel - prevNivel;
        const duracion = (fecha - prevFecha)/(1000*60);
        const hora = fecha.getHours();

        let descripcion = '', tipo = '';

        if(nivel < historico.promedio - 0.1 && (hora <6 || hora>=16)){
          descripcion = `Extracción fuera de horario (${hora}:00 h)`; tipo='alerta';
        } else if(cambio < -historico.desviacion && duracion<=60){
          descripcion = `Descenso súbito de ${Math.abs(cambio).toFixed(2)} m en ${duracion.toFixed(2)} min`; tipo='descenso';
        } else if(cambio > historico.desviacion && duracion<=60){
          descripcion = `Subida súbita de ${cambio.toFixed(2)} m en ${duracion.toFixed(2)} min`; tipo='subida';
        }

        if(descripcion) eventos.push({
          fechaHora: fecha.toLocaleString(),
          nivel: nivel.toFixed(2),
          duracion: duracion.toFixed(2),
          descripcion,
          tipo
        });

        prevNivel = nivel;
        prevFecha = fecha;
      }
      return eventos;
    }
  }

    fetchAlertas();
  </script>
</body>
</html>
