<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle Alertas - Tanque Alcaldes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    .card {
      width: 100%;
      background: linear-gradient(145deg, #2c3e50, #34495e);
      border-radius: 15px;
      margin-bottom: 20px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s, box-shadow 0.3s;
      box-sizing: border-box;
    }
    .chart-container {
      width: 100%;
      height: 300px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      background-color: #2c3e50;
      color: #ecf0f1;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #34495e;
    }
    th {
      background-color: #34495e;
    }
    .navbar {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Tanque Alcaldes</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Análisis General</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reporte.html">Reporte</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="seguridad.html">Seguridad</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="trabajando.html">Análisis</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="detalle_alertas.html">Detalle Alertas</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <h1 class="text-center mb-4">Detalle de Alertas Nocturnas - Tanque Alcaldes</h1>

  <!-- Tabla de eventos -->
  <div class="card">
    <h4 class="text-center">Eventos Significativos Nocturnos</h4>
    <div class="table-container">
      <table id="eventosTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha/Hora Inicio</th>
            <th>Fecha/Hora Fin</th>
            <th>Duración (min)</th>
            <th>Cambio en Nivel (m)</th>
            <th>Nivel Inicial (m)</th>
            <th>Nivel Final (m)</th>
            <th>Metros Cúbicos Extraídos</th>
            <th>Posible Causa</th>
          </tr>
        </thead>
        <tbody id="eventosBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Gráfica del evento seleccionado -->
  <div class="card">
    <h4 class="text-center">Gráfica del Evento</h4>
    <div class="chart-container">
      <canvas id="eventoChart"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  async function fetchData() {
    const csvUrl = 'https://raw.githubusercontent.com/Oraida14/grafica_alcaldes/master/static/tanque_alcaldes.csv';
    const areaBaseTanque = 1720.57; // Área de la base del tanque en metros cuadrados

    try {
      // Cargar datos CSV
      const response = await fetch(csvUrl);
      const csvText = await response.text();
      const results = Papa.parse(csvText, { header: true, dynamicTyping: false });
      let data = results.data;

      // Filtrar niveles cero que duren menos de 30 minutos
      let filteredData = [];
      let zeroStartTime = null;

      for (let i = 0; i < data.length; i++) {
        if (data[i].Nivel_1 == 0) {
          if (zeroStartTime === null) {
            zeroStartTime = new Date(data[i].fecha_hora);
          }
          // Si es el último dato, añadirlo si no supera los 30 minutos
          if (i === data.length - 1 && zeroStartTime !== null) {
            let zeroEndTime = new Date(data[i].fecha_hora);
            let zeroDuration = (zeroEndTime - zeroStartTime) / (1000 * 60); // Duración en minutos
            if (zeroDuration > 30) { // Si dura más de 30 minutos, incluirlo
              filteredData.push(data[i]);
            }
          }
        } else {
          if (zeroStartTime !== null) {
            let zeroEndTime = new Date(data[i - 1].fecha_hora);
            let zeroDuration = (zeroEndTime - zeroStartTime) / (1000 * 60); // Duración en minutos
            if (zeroDuration > 30) { // Si dura más de 30 minutos, incluir los ceros
              for (let j = i - 1; j >= 0 && new Date(data[j].fecha_hora) >= zeroStartTime; j--) {
                filteredData.push(data[j]);
              }
            }
            zeroStartTime = null;
          }
          filteredData.push(data[i]);
        }
      }

      console.log("Datos filtrados:", filteredData);

      // Filtrar datos nocturnos (16:00 - 06:00)
      const filteredDataNoche = filteredData.filter(d => {
        const fechaHora = new Date(d.fecha_hora);
        const hora = fechaHora.getHours();
        return hora >= 16 || hora < 6;
      });

      console.log("Datos nocturnos filtrados:", filteredDataNoche);

      // Agrupar datos por hora para calcular comportamiento típico
      const comportamientoPorHora = {};
      filteredData.forEach(d => {
        const fechaHora = new Date(d.fecha_hora);
        const hora = fechaHora.getHours();

        if (!comportamientoPorHora[hora]) {
          comportamientoPorHora[hora] = { niveles: [] };
        }
        comportamientoPorHora[hora].niveles.push(parseFloat(d.Nivel_1));
      });

      console.log("Comportamiento por hora:", comportamientoPorHora);

      // Calcular promedio y desviación estándar por hora
      const estadisticasPorHora = {};
      for (const hora in comportamientoPorHora) {
        const niveles = comportamientoPorHora[hora].niveles;
        const promedio = niveles.reduce((a, b) => a + b, 0) / niveles.length;
        const desviacionEstandar = Math.sqrt(niveles.reduce((sq, n) => sq + Math.pow(n - promedio, 2), 0) / niveles.length);
        estadisticasPorHora[hora] = { promedio, desviacionEstandar };
      }

      console.log("Estadísticas por hora:", estadisticasPorHora);

      // Detectar caídas inusuales en datos nocturnos
      const alertas = [];
      let eventoId = 1;
      let enEvento = false;
      let inicioEvento = null;
      let nivelInicialEvento = null;
      let nivelMinimoEvento = null;

      for (let i = 0; i < filteredDataNoche.length; i++) {
        const fechaHoraActual = new Date(filteredDataNoche[i].fecha_hora);
        const horaActual = fechaHoraActual.getHours();
        const nivelActual = parseFloat(filteredDataNoche[i].Nivel_1);

        if (!enEvento) {
          if (i < filteredDataNoche.length - 1) {
            const nivelSiguiente = parseFloat(filteredDataNoche[i + 1].Nivel_1);
            const cambioNivel = nivelActual - nivelSiguiente;

            if (cambioNivel > 0.1 && estadisticasPorHora[horaActual]) { // Cambio mínimo de 0.1 metros para considerar un evento
    const umbralInferior = estadisticasPorHora[horaActual].promedio - 2 * estadisticasPorHora[horaActual].desviacionEstandar;
    if (nivelSiguiente < umbralInferior) {
        enEvento = true;
        inicioEvento = filteredDataNoche[i].fecha_hora;
        nivelInicialEvento = nivelActual;
        nivelMinimoEvento = nivelSiguiente;
    }
}

          }
        } else {
          if (i === filteredDataNoche.length - 1 || parseFloat(filteredDataNoche[i + 1].Nivel_1) >= nivelMinimoEvento) {
            const fechaHoraFin = new Date(filteredDataNoche[i].fecha_hora);
            const duracionEvento = (fechaHoraFin - new Date(inicioEvento)) / (1000 * 60);
            const cambioNivel = nivelInicialEvento - parseFloat(filteredDataNoche[i].Nivel_1);
            const metrosCubicosExtraidos = (cambioNivel * areaBaseTanque).toFixed(2);

            alertas.push({
              id: eventoId++,
              inicio: inicioEvento,
              fin: filteredDataNoche[i].fecha_hora,
              duracion: duracionEvento.toFixed(2),
              cambioNivel: cambioNivel.toFixed(2),
              nivelInicial: nivelInicialEvento.toFixed(2),
              nivelFinal: parseFloat(filteredDataNoche[i].Nivel_1).toFixed(2),
              metrosCubicosExtraidos: metrosCubicosExtraidos,
              posibleCausa: `Caída inusual: ${cambioNivel.toFixed(2)}m en ${duracionEvento.toFixed(2)} minutos (por debajo de ${(estadisticasPorHora[horaActual].promedio - 2 * estadisticasPorHora[horaActual].desviacionEstandar).toFixed(2)}m)`
            });

            enEvento = false;
            inicioEvento = null;
            nivelInicialEvento = null;
            nivelMinimoEvento = null;
          } else {
            nivelMinimoEvento = Math.min(nivelMinimoEvento, nivelActual);
          }
        }
      }

      console.log("Alertas detectadas:", alertas);

      // Mostrar alertas en la tabla
      const eventosBody = document.getElementById('eventosBody');
      if (alertas.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="9">No se detectaron alertas.</td>`;
        eventosBody.appendChild(row);
      } else {
        alertas.forEach(alerta => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${alerta.id}</td>
            <td>${alerta.inicio}</td>
            <td>${alerta.fin}</td>
            <td>${alerta.duracion}</td>
            <td>${alerta.cambioNivel}</td>
            <td>${alerta.nivelInicial}</td>
            <td>${alerta.nivelFinal}</td>
            <td>${alerta.metrosCubicosExtraidos}</td>
            <td>${alerta.posibleCausa}</td>
          `;
          row.addEventListener('click', () => mostrarGraficaEvento(alerta, filteredDataNoche));
          eventosBody.appendChild(row);
        });
      }
    } catch (error) {
      console.error("Error al cargar los datos:", error);
      const eventosBody = document.getElementById('eventosBody');
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="9">Error al cargar los datos: ${error.message}</td>`;
      eventosBody.appendChild(row);
    }
  }

  function mostrarGraficaEvento(evento, data) {
    const inicioIdx = data.findIndex(d => d.fecha_hora === evento.inicio);
    const finIdx = data.findIndex(d => d.fecha_hora === evento.fin);
    const eventoData = data.slice(inicioIdx, finIdx + 1);

    const ctx = document.getElementById('eventoChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: eventoData.map(d => d.fecha_hora),
        datasets: [{
          label: 'Nivel (m)',
          data: eventoData.map(d => parseFloat(d.Nivel_1)),
          borderColor: 'rgba(219, 52, 52, 1)',
          backgroundColor: 'rgba(219, 52, 52, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 5,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: `Evento ${evento.id}: Caída inusual de ${evento.cambioNivel}m en ${evento.duracion} minutos`,
            color: '#ecf0f1',
            font: { size: 16 }
          }
        },
        scales: {
          x: { ticks: { color: '#bdc3c7' }, title: { display: true, text: 'Fecha/Hora', color: '#ecf0f1' } },
          y: { ticks: { color: '#bdc3c7' }, title: { display: true, text: 'Nivel (m)', color: '#ecf0f1' } }
        }
      }
    });
  }

  fetchData();
</script>

</body>
</html>
