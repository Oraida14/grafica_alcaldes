<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Detalle Alertas - Tanque Alcaldes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    .card {
      width: 100%;
      background: linear-gradient(145deg, #2c3e50, #34495e);
      border-radius: 15px;
      margin-bottom: 20px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      transition: transform 0.3s, box-shadow 0.3s;
      box-sizing: border-box;
    }
    .chart-container {
      width: 100%;
      height: 300px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }
    .table-container {
      overflow-x: auto;
    }
    table {
      width: 100%;
      background-color: #2c3e50;
      color: #ecf0f1;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #34495e;
    }
    th {
      background-color: #34495e;
    }
    .navbar {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">Tanque Alcaldes</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Análisis General</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reporte.html">Reporte</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="seguridad.html">Seguridad</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="trabajando.html">Análisis</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="detalle_alertas.html">Detalle Alertas</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <h1 class="text-center mb-4">Detalle de Alertas Nocturnas - Tanque Alcaldes</h1>
  <!-- Tabla de eventos -->
  <div class="card">
    <h4 class="text-center">Eventos Significativos Nocturnos</h4>
    <div class="table-container">
      <table id="eventosTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha/Hora Inicio</th>
            <th>Fecha/Hora Fin</th>
            <th>Duración (min)</th>
            <th>Cambio en Nivel (m)</th>
            <th>Nivel Inicial (m)</th>
            <th>Nivel Final (m)</th>
            <th>Metros Cúbicos Extraídos</th>
            <th>Posible Causa</th>
          </tr>
        </thead>
        <tbody id="eventosBody"></tbody>
      </table>
    </div>
  </div>
  <!-- Gráfica del evento seleccionado -->
  <div class="card">
    <h4 class="text-center">Gráfica del Evento</h4>
    <div class="chart-container">
      <canvas id="eventoChart"></canvas>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let eventoChart = null; // Variable global para almacenar la gráfica

    async function fetchData() {
      const csvUrl = 'https://raw.githubusercontent.com/Oraida14/grafica_alcaldes/master/static/tanque_alcaldes.csv';
      const areaBaseTanque = 1720.57; // Área de la base del tanque en metros cuadrados

      try {
        // Cargar datos CSV
        const response = await fetch(csvUrl);
        const csvText = await response.text();
        const results = Papa.parse(csvText, { header: true, dynamicTyping: false });
        let data = results.data;

        // Filtrar valores cero temporales
        data = filtrarCerosTemporales(data);

        // Filtrar datos nocturnos (16:00 - 06:00)
        const filteredDataNoche = data.filter(d => {
          const fechaHora = new Date(d.fecha_hora);
          const hora = fechaHora.getHours();
          return hora >= 16 || hora < 6;
        });

        // Agrupar datos por hora para calcular comportamiento típico
        const comportamientoPorHora = {};
        data.forEach(d => {
          const fechaHora = new Date(d.fecha_hora);
          const hora = fechaHora.getHours();
          if (!comportamientoPorHora[hora]) {
            comportamientoPorHora[hora] = { niveles: [] };
          }
          comportamientoPorHora[hora].niveles.push(parseFloat(d.Nivel_1));
        });

        // Calcular promedio y desviación estándar por hora
        const estadisticasPorHora = {};
        for (const hora in comportamientoPorHora) {
          const niveles = comportamientoPorHora[hora].niveles;
          const promedio = niveles.reduce((a, b) => a + b, 0) / niveles.length;
          const desviacionEstandar = Math.sqrt(niveles.reduce((sq, n) => sq + Math.pow(n - promedio, 2), 0) / niveles.length);
          estadisticasPorHora[hora] = { promedio, desviacionEstandar };
        }

        // Detectar caídas inusuales en datos nocturnos
        const alertas = [];
        let eventoId = 1;
        for (let i = 1; i < filteredDataNoche.length; i++) {
          const fechaHoraActual = new Date(filteredDataNoche[i].fecha_hora);
          const horaActual = fechaHoraActual.getHours();
          const cambioNivel = parseFloat(filteredDataNoche[i - 1].Nivel_1) - parseFloat(filteredDataNoche[i].Nivel_1);
          const tiempoTranscurrido = (fechaHoraActual - new Date(filteredDataNoche[i - 1].fecha_hora)) / (1000 * 60);
          if (cambioNivel > 0 && estadisticasPorHora[horaActual]) {
            const umbralInferior = estadisticasPorHora[horaActual].promedio - 2 * estadisticasPorHora[horaActual].desviacionEstandar;
            if (parseFloat(filteredDataNoche[i].Nivel_1) < umbralInferior) {
              const metrosCubicosExtraidos = (cambioNivel * areaBaseTanque).toFixed(2);
              alertas.push({
                id: eventoId++,
                inicio: filteredDataNoche[i - 1].fecha_hora,
                fin: filteredDataNoche[i].fecha_hora,
                duracion: tiempoTranscurrido.toFixed(2),
                cambioNivel: cambioNivel.toFixed(2),
                nivelInicial: parseFloat(filteredDataNoche[i - 1].Nivel_1).toFixed(2),
                nivelFinal: parseFloat(filteredDataNoche[i].Nivel_1).toFixed(2),
                metrosCubicosExtraidos: metrosCubicosExtraidos,
                posibleCausa: `Caída inusual: ${cambioNivel.toFixed(2)}m en ${tiempoTranscurrido.toFixed(2)} minutos (por debajo de ${umbralInferior.toFixed(2)}m)`
              });
            }
          }
        }

        // Mostrar alertas en la tabla
        const eventosBody = document.getElementById('eventosBody');
        if (alertas.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="9">No se detectaron alertas.</td>`;
          eventosBody.appendChild(row);
        } else {
          alertas.forEach(alerta => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${alerta.id}</td>
              <td>${alerta.inicio}</td>
              <td>${alerta.fin}</td>
              <td>${alerta.duracion}</td>
              <td>${alerta.cambioNivel}</td>
              <td>${alerta.nivelInicial}</td>
              <td>${alerta.nivelFinal}</td>
              <td>${alerta.metrosCubicosExtraidos}</td>
              <td>${alerta.posibleCausa}</td>
            `;
            row.addEventListener('click', () => mostrarGraficaEvento(alerta, filteredDataNoche));
            eventosBody.appendChild(row);
          });
        }
      } catch (error) {
        console.error("Error al cargar los datos:", error);
        const eventosBody = document.getElementById('eventosBody');
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="9">Error al cargar los datos: ${error.message}</td>`;
        eventosBody.appendChild(row);
      }
    }

    function filtrarCerosTemporales(data) {
      let dataFiltrada = [];
      let i = 0;
      while (i < data.length) {
        if (parseFloat(data[i].Nivel_1) === 0) {
          let inicioCeros = i;
          while (i < data.length && parseFloat(data[i].Nivel_1) === 0) {
            i++;
          }
          const finCeros = i - 1;
          const duracionCeros = (new Date(data[finCeros].fecha_hora) - new Date(data[inicioCeros].fecha_hora)) / (1000 * 60);
          if (duracionCeros <= 30) {
            // Ignorar ceros temporales
            dataFiltrada.push(...data.slice(inicioCeros, finCeros + 1).map(d => ({ ...d, Nivel_1: dataFiltrada.length > 0 ? dataFiltrada[dataFiltrada.length - 1].Nivel_1 : 0 })));
          } else {
            // Mantener ceros si duran más de 30 minutos
            dataFiltrada.push(...data.slice(inicioCeros, finCeros + 1));
          }
        } else {
          dataFiltrada.push(data[i]);
          i++;
        }
      }
      return dataFiltrada;
    }

    function mostrarGraficaEvento(evento, data) {
      const inicioIdx = data.findIndex(d => d.fecha_hora === evento.inicio);
      const finIdx = data.findIndex(d => d.fecha_hora === evento.fin);
      const eventoData = data.slice(inicioIdx, finIdx + 1);

      const ctx = document.getElementById('eventoChart').getContext('2d');

      // Destruir gráfica anterior si existe
      if (eventoChart) {
        eventoChart.destroy();
      }

      eventoChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: eventoData.map(d => d.fecha_hora),
          datasets: [{
            label: 'Nivel (m)',
            data: eventoData.map(d => parseFloat(d.Nivel_1)),
            borderColor: 'rgba(219, 52, 52, 1)',
            backgroundColor: 'rgba(219, 52, 52, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: `Evento ${evento.id}: Caída inusual de ${evento.cambioNivel}m en ${evento.duracion} minutos`,
              color: '#ecf0f1',
              font: { size: 16 }
            }
          },
          scales: {
            x: { ticks: { color: '#bdc3c7' }, title: { display: true, text: 'Fecha/Hora', color: '#ecf0f1' } },
            y: { ticks: { color: '#bdc3c7' }, title: { display: true, text: 'Nivel (m)', color: '#ecf0f1' } }
          }
        }
      });
    }

    fetchData();
  </script>
</body>
</html>
